name: Docker Build and Push

on:
  push:
    branches: [ master, main ]
    tags: [ '*' ]
  pull_request:
    branches: [ master, main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for testing
        run: |
          docker build -t pg-repack-test .

      - name: Test pg_repack version
        run: |
          output=$(docker run --rm pg-repack-test pg_repack --version 2>&1)
          echo "Command output: $output"
          echo "Raw output (with special chars): $(echo "$output" | cat -A)"

          # More flexible version check - look for pg_repack and version pattern
          if echo "$output" | grep -i "pg_repack" | grep -E "[0-9]+\.[0-9]+(\.[0-9]+)?"; then
            echo "✅ Test passed: pg_repack version command works correctly"
          else
            echo "❌ Test failed: pg_repack version command did not produce expected output"
            echo "Expected format: pg_repack followed by version number (e.g., pg_repack 1.5.2)"
            exit 1
          fi

  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Determine if we should push
        id: push-check
        run: |
          SHOULD_PUSH=false
          if [[ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]]; then
            SHOULD_PUSH=true
          fi
          echo "push=$SHOULD_PUSH" >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        if: steps.push-check.outputs.push == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate tags
        if: steps.push-check.outputs.push == 'true'
        id: tags
        run: |
          SHORT_HASH=$(echo "${{ github.sha }}" | cut -c1-7)
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            echo "tags=hartmutcouk/pg-repack-docker:$TAG,hartmutcouk/pg-repack-docker:latest" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "tags=hartmutcouk/pg-repack-docker:pr-${{ github.event.number }}.${SHORT_HASH}" >> "$GITHUB_OUTPUT"
          else
            BRANCH_NAME=$(echo "${GITHUB_REF#refs/heads/}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
            echo "tags=hartmutcouk/pg-repack-docker:${BRANCH_NAME}.${SHORT_HASH}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build multi-platform image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ steps.push-check.outputs.push }}
          tags: ${{ steps.tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
